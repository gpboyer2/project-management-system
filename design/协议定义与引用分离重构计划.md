# 协议定义与引用分离重构计划

## 1. 核心理念 (Design Philosophy)

*   **Single Source of Truth (单一事实来源)**：资源管理器中的“协议集”是报文定义的唯一源头。
*   **引用即只读 (Reference is Read-only)**：具体软件中的接口配置仅作为对标准协议的“引用”，不应具备修改报文结构的权限。
*   **极简查阅 (Simplified Viewing)**：只读界面应去除构建工具（如拖拽、工具箱），专注于信息展示。
*   **上下文导航 (Contextual Navigation)**：提供从“使用场景”（软件接口）一键跳转回“定义场景”（协议集）的能力。

## 2. 交互行为差异对比 (Interaction Specification)

我们将在同一个编辑器组件中支持两种模式，通过 `readonly` 属性进行切换。

| 界面模块 | 协议集编辑器 (Source) | 软件接口视图 (Reference) |
| :--- | :--- | :--- |
| **所属位置** | 资源管理器 > 协议集 > 具体协议 | 资源管理器 > 系统/设备 > 软件 > 接口列表 |
| **模式** | **定义模式 (Full Edit)** | **只读模式 (Read-only)** |
| **左侧：报文列表** | ✅ 新增/删除/重命名报文 | 🔒 仅查看列表 (或仅显示当前引用的报文) |
| **中间：协议结构** | ✅ 支持拖拽排序<br>✅ 支持嵌套层级调整<br>✅ 支持内联编辑 (长度/类型) | 🚫 **禁用拖拽**<br>🔒 字段属性只读<br>🔒 禁用删除操作 |
| **中间：空状态** | 提示“从右侧拖拽字段” | 提示“暂无字段” (无操作引导) |
| **右侧：侧边栏** | ✅ **显示工具箱 (Toolbox)**<br>✅ 显示属性面板 | 🚫 **隐藏工具箱**<br>✅ 仅显示属性面板 (用于查看详细约束) |
| **顶部：工具栏** | 💾 **“保存”按钮** | 🔗 **“编辑报文定义”按钮**<br>*(点击跳转到协议集)* |

## 3. 技术实施方案 (Technical Implementation)

### 3.1 核心组件抽离与改造 (`PacketDefinitionEditor.vue`)

**目标**：将 `InterfaceEditor.vue` 中的核心编辑逻辑剥离为独立组件 `PacketDefinitionEditor.vue`，实现纯粹的报文结构展示与编辑。

1.  **组件拆分**:
    *   **`PacketDefinitionEditor.vue`**: 负责报文内容的呈现（中间列表区域）和右侧面板（工具箱/属性）。
        *   **Props**:
            *   `packetData`: 完整的报文数据对象。
            *   `readonly`: Boolean，控制编辑模式。
        *   **功能**:
            *   处理拖拽逻辑 (仅 `!readonly`)。
            *   渲染字段列表。
            *   处理属性侧边栏显示逻辑。

    *   **`InterfaceEditor.vue`** (容器组件):
        *   负责左侧报文列表的管理（增删改查）。
        *   负责调用后端 API 获取/保存数据。
        *   负责页面整体布局（Header, Actions）。
        *   引入 `PacketDefinitionEditor.vue` 作为子组件。

2.  **`PacketDefinitionEditor.vue` 内部改造**:
    *   **右侧栏 (`aside`)**:
        *   `readonly=true`: 隐藏 Tab 切换，移除工具箱 DOM，仅保留属性面板插槽或组件。
    *   **中间区域 (`main`)**:
        *   `readonly=true`: `VueDraggable` 禁用 (`disabled=true`)。
        *   隐藏所有操作入口：拖拽手柄、删除按钮、添加按钮。
        *   输入框转为文本展示。

### 3.2 数据层架构调整 (Data Architecture)

**目标**：杜绝数据冗余，确保软件接口仅持有引用。

1.  **Store 改造**:
    *   **`usePacketStore` (新增/强化)**:
        *   作为**单一事实来源**。
        *   存储所有 `ICD Bundles` 及其下的 `Packets` 定义。
        *   提供 `getPacketById(id)` 方法供各处调用。

    *   **软件接口数据结构**:
        *   **当前**: 包含完整的 `fields` 数组。
        *   **目标**: 仅存储 `packetId` (关联协议集中的 ID) 和 `role` (Pub/Sub)。
        *   **渲染逻辑**: 组件挂载时，使用 `packetId` 从 `usePacketStore` 拉取最新的 `fields` 结构进行渲染。

2.  **数据流向**:
    *   **协议集编辑器**: 修改 -> `PacketStore` 更新 -> 后端同步。
    *   **软件接口视图**: 读取 `packetId` -> 从 `PacketStore` 获取结构 -> 渲染 (Read-only)。

### 3.3 调用点集成

1.  **协议集编辑器 (`IcdBundleEditor.vue`)**:
    *   直接使用 `InterfaceEditor` (容器) 或 `PacketDefinitionEditor`。
    *   传入 `readonly=false`。

2.  **软件接口视图**:
    *   根据 `packetId` 获取数据。
    *   使用 `PacketDefinitionEditor`。
    *   传入 `readonly=true`。
    *   增加“跳转编辑”按钮，点击后导航至协议集编辑器对应条目。

## 4. 实施进度

| 步骤 | 描述 | 状态 |
| :--- | :--- | :--- |
| 第一步 | 创建 `PacketDefinitionEditor.vue`，迁移核心代码 | ✅ 已完成 |
| 第二步 | 在 `InterfaceEditor.vue` 中引用新组件 | ✅ 已完成 |
| 第三步 | 在 `IcdBundleEditor.vue` 中集成编辑器 | ✅ 已完成 |
| 第四步 | 实现 `readonly` 逻辑分支 | ✅ 已完成 |
| 第五步 | 创建 `useIcdStore` 作为单一事实来源 | ✅ 已完成 |
| 第六步 | 修改组件使用 Store 数据 | ✅ 已完成 |
| 第七步 | 报文列表显示控制与选中报文同步 | ✅ 已完成 |

## 5. 组件使用说明

### 5.1 协议集编辑器 (全功能模式)

在 `IcdBundleEditor.vue` 中已集成，点击"报文定义" Tab 即可使用完整编辑功能。

**调用方式**:
```vue
<InterfaceEditor
  :interface-id="icdId"
  :interface-name="icdName"
  :readonly="false"
  :show-packet-list="false"
  :selected-packet-id="currentPacketId"
  @save="handlePacketSave"
/>
```

**关键 Props**:
- `showPacketList=false`: 协议集编辑器不显示左侧报文列表（报文通过资源管理器树选择）
- `selectedPacketId`: 从外部传入当前选中的报文 ID（点击资源管理器中的报文节点时更新）

### 5.2 软件接口视图 (只读模式)

```vue
<template>
  <InterfaceEditor
    :interface-id="protocolId"
    :readonly="true"
    :show-packet-list="true"
    :source-protocol-id="protocolId"
    :source-packet-id="currentPacketId"
    @navigate-to-definition="handleNavigate"
  />
</template>
```

**Props 说明**:
- `interfaceId`: 关联的协议集 ID（用于从 Store 获取报文数据）
- `readonly`: 设置为 `true` 启用只读模式
- `showPacketList`: 设置为 `true` 显示左侧报文列表（仅软件接口视图需要）
- `sourceProtocolId`: 源协议 ID，用于跳转
- `sourcePacketId`: 源报文 ID，用于跳转

**只读模式特性**:
- 显示左侧报文列表（用户可以切换查看不同报文）
- 隐藏工具箱，仅显示属性面板
- 禁用拖拽和编辑操作
- 显示"编辑报文定义"按钮，点击跳转到协议集

### 5.3 ICD Store 使用说明

```typescript
import { useIcdStore } from '@/stores'

const icdStore = useIcdStore()

// 初始化示例数据（开发阶段）
icdStore.initSampleData()

// 获取协议集
const bundle = icdStore.getBundleById('icd-inter-station')

// 获取报文（跨协议集查找）
const packet = icdStore.getPacketById('msg-heartbeat')

// 添加报文到协议集
icdStore.addPacket('icd-inter-station', {
  name: 'New_Message',
  version: '1.0',
  fields: []
})

// 保存报文列表
icdStore.savePacketList('icd-inter-station', updatedPacketList)

// 检查引用是否过期
const isOutdated = icdStore.checkRefOutdated({
  packetId: 'msg-heartbeat',
  bundleId: 'icd-inter-station',
  role: 'Sub',
  localVersion: 'v1.0'
})
```

**Store 数据结构**:
- `bundleList`: 协议集列表
- `activeBundleId`: 当前选中的协议集 ID
- `activePacketId`: 当前选中的报文 ID
