
## 层级拓扑视图 - 聚焦模式功能说明文档

---

### 一、功能概述

层级拓扑视图是一个可视化展示系统架构层级关系的页面，支持从"系统→设备→软件→协议"四个层级逐级查看节点之间的通信关联关系。

**核心特性**：
- **层级切换**：通过加减号按钮在不同层级间切换
- **聚焦模式**：点击任意节点可进入聚焦模式，突出显示该节点及其关联关系
- **双图层架构**：聚焦时采用双图层设计，原始视图虚化，聚焦内容独立呈现

---

### 二、页面布局

```
┌─────────────────────────────────────────────────────────────────┐
│  顶部导航栏（标题、当前层级指示、操作按钮）                          │
├─────────────────────────────────────────────────────┬───────────┤
│                                                     │           │
│                                                     │   右侧    │
│                    中央画布区域                       │   详情    │
│              （拓扑图 + 工具栏 + 图例）                │   面板    │
│                                                     │           │
│                                                     │           │
└─────────────────────────────────────────────────────┴───────────┘
```

**布局说明**：
- **顶部导航栏**：显示系统标题、当前层级名称（如"系统"）、层级路径（如"1/4"）、操作按钮
- **中央画布**：展示当前层级的所有节点和连线关系
- **右侧详情面板**：显示选中节点的详细信息

---

### 三、层级体系

| 层级 | 名称 | 说明 | 示例 |
|------|------|------|------|
| 1 | 系统 | 最顶层，展示不同系统之间的关联 | 卫星测控系统、导弹测试系统、空间站通信系统 |
| 2 | 设备 | 展示不同设备之间的关联 | 地面站A、测试控制器、通信集线器 |
| 3 | 软件 | 展示不同软件之间的关联 | 遥测处理软件、轨道计算软件、协议栈软件 |
| 4 | 协议 | 最底层，展示不同协议之间的数据流转 | TCP-TM01、UDP-DA01、CCSDS-PS02 |

**层级切换**：
- 点击工具栏的 **"+"** 按钮：进入下一层级（放大/深入）
- 点击工具栏的 **"-"** 按钮：返回上一层级（缩小/概览）
- 点击面包屑导航：直接跳转到指定层级

---

### 四、聚焦模式（核心功能）

#### 4.1 设计理念

当用户点击某个节点时，表明用户想要**聚焦查看**该节点的关联关系。此时：
- 用户关心的是：**"它是谁？它连接了谁？谁跟它有关系？"**
- 无关的节点应该**虚化淡出**，不干扰用户视线
- 聚焦的节点应该**居中突出**，成为视觉焦点

#### 4.2 双图层架构

为了实现平滑的聚焦效果，采用**双图层**设计：

```
┌─────────────────────────────────────────────┐
│           聚焦图层（Focus Layer）            │  ← z-index: 200
│   ┌─────────────────────────────────────┐   │
│   │  克隆的聚焦节点 + 关联节点 + 新连线   │   │
│   └─────────────────────────────────────┘   │
├─────────────────────────────────────────────┤
│           原始图层（Base Layer）             │  ← z-index: 5
│   ┌─────────────────────────────────────┐   │
│   │  所有原始节点 + 原始连线（已虚化）    │   │
│   └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

**原始图层**：
- 包含所有节点和连线
- 聚焦时整体虚化（透明度降低 + 模糊效果）
- 节点位置保持不变

**聚焦图层**：
- 动态创建，仅在聚焦模式下存在
- 包含聚焦节点和关联节点的**克隆副本**
- 包含重新绘制的连线
- 取消聚焦时整体移除

#### 4.3 聚焦动画流程

```
用户点击节点
    ↓
1. 虚化原始图层
   - 所有原始节点添加 .dimmed 类
   - 所有原始连线添加 .dimmed 类
   - 效果：透明度降至15%，轻微模糊
    ↓
2. 创建聚焦图层
   - 创建 #focus-layer 容器
   - 创建 SVG 连线层
    ↓
3. 克隆节点并动画
   - 从原位置复制聚焦节点
   - 从原位置复制所有关联节点
   - 动画移动到目标位置：
     · 聚焦节点 → 画布中心，放大1.3倍
     · 关联节点 → 环形围绕聚焦节点，放大1.05倍
   - 动画时长：500ms，缓动函数：cubic-bezier(0.4, 0, 0.2, 1)
    ↓
4. 绘制新连线（延迟300ms）
   - 根据新位置计算连线路径
   - 绘制贝塞尔曲线连线
   - 添加箭头和标签
   - 淡入显示
    ↓
5. 更新右侧详情面板
   - 显示聚焦节点的基本信息
   - 显示关联节点列表
   - 显示子节点列表（如有）
```

#### 4.4 节点位置计算

**聚焦节点**：
- 位置：画布中心
- 计算公式：`centerX = (canvasWidth - 360) / 2 - 70`，`centerY = (canvasHeight - 140) / 2 - 40`

**关联节点**：
- 位置：以聚焦节点为圆心，半径200px的圆周上均匀分布
- 计算公式：
  ```javascript
  angle = (index * 2 * Math.PI / relatedCount) - Math.PI / 2
  x = centerX + 200 * Math.cos(angle)
  y = centerY + 200 * Math.sin(angle)
  ```

#### 4.5 视觉效果

| 元素 | 正常状态 | 聚焦状态 |
|------|----------|----------|
| 聚焦节点 | 正常显示 | 居中、放大1.3倍、青色边框、发光效果 |
| 关联节点 | 正常显示 | 环形排列、放大1.05倍、橙色边框、显示关联标签 |
| 无关节点 | 正常显示 | 虚化（透明度15%、模糊、缩小0.9倍） |
| 关联连线 | 正常显示 | 加粗、发光、高亮 |
| 无关连线 | 正常显示 | 虚化（透明度10%） |

---

### 五、用户交互

#### 5.1 进入聚焦模式

**操作**：单击任意节点

**效果**：
1. 原始视图整体虚化
2. 被点击的节点从原位置"飞入"画布中心
3. 与其有连接关系的节点从各自原位置"飞入"周围
4. 连线重新绘制，指向新位置
5. 右侧面板更新为该节点的详情

#### 5.2 切换聚焦目标

**操作**：在聚焦模式下，点击任意关联节点

**效果**：
1. 清除当前聚焦图层
2. 以新点击的节点为中心重新聚焦
3. 动画效果同上

#### 5.3 退出聚焦模式

**操作**（三种方式）：
1. 再次点击当前聚焦的节点
2. 点击画布空白区域
3. 点击顶部"重置聚焦"按钮

**效果**：
1. 聚焦图层整体移除
2. 原始图层恢复正常显示
3. 右侧面板恢复为空状态

#### 5.4 其他交互

| 操作 | 效果 |
|------|------|
| 点击 "+" 按钮 | 进入下一层级 |
| 点击 "-" 按钮 | 返回上一层级 |
| 点击面包屑 | 跳转到指定层级 |
| 点击"刷新"按钮 | 重新渲染当前层级 |
| 点击"导出"按钮 | 导出视图（待实现） |
| 点击右侧面板的关联节点 | 切换聚焦到该节点 |
| 点击右侧面板的子节点 | 进入下一层级 |

---

### 六、技术实现要点

#### 6.1 关键函数

| 函数名 | 功能 |
|--------|------|
| [focusNode(nodeId)](cssc-node-view/cache/13/script.js:707:0-822:1) | 进入聚焦模式的主函数 |
| [createFocusNodeClone()](cssc-node-view/cache/13/script.js:824:0-868:1) | 创建节点克隆并设置动画 |
| [renderFocusConnections()](cssc-node-view/cache/13/script.js:870:0-921:1) | 在聚焦图层绘制连线 |
| [clearFocusLayer()](cssc-node-view/cache/13/script.js:923:0-929:1) | 清除聚焦图层 |
| [resetFocus()](cssc-node-view/cache/13/script.js:951:0-977:1) | 退出聚焦模式 |
| [getRelatedNodeIds()](cssc-node-view/cache/13/script.js:931:0-943:1) | 获取与指定节点有连接的所有节点ID |

#### 6.2 关键样式类

| 类名 | 作用 |
|------|------|
| `.focus-layer` | 聚焦图层容器 |
| `.focus-clone` | 克隆节点基础样式 |
| `.focus-clone.focused` | 聚焦节点样式（居中、放大、青色边框） |
| `.focus-clone.related` | 关联节点样式（橙色边框） |
| `.dimmed` | 虚化状态（透明度15%、模糊） |
| `.focus-path` | 聚焦连线样式（加粗、发光） |
| `.relation-badge` | 关联关系标签 |

#### 6.3 动画参数

| 参数 | 值 |
|------|-----|
| 节点移动动画时长 | 500ms |
| 节点移动缓动函数 | cubic-bezier(0.4, 0, 0.2, 1) |
| 连线绘制延迟 | 300ms |
| 连线淡入时长 | 300ms |
| 聚焦节点放大比例 | 1.3 |
| 关联节点放大比例 | 1.05 |
| 虚化节点缩小比例 | 0.9 |

---

### 七、右侧详情面板

#### 7.1 面板结构

```
┌─────────────────────────────┐
│  节点详情                    │
│  [节点名称]                  │
├─────────────────────────────┤
│  基本信息                    │
│  ├─ 名称：xxx               │
│  ├─ 层级：系统/设备/软件/协议│
│  ├─ 协议类型：TCP/UDP/...   │
│  ├─ 端口：8001              │
│  └─ 状态：在线运行/负载较高  │
├─────────────────────────────┤
│  描述                        │
│  [节点描述文字]              │
├─────────────────────────────┤
│  🔗 关联节点 (N)             │
│  ├─ [图标] 节点A             │
│  │       → 输出到：数据同步  │
│  ├─ [图标] 节点B             │
│  │       ← 输入自：遥控指令  │
│  └─ ...                     │
├─────────────────────────────┤
│  包含的[下级层级名] (N)       │
│  ├─ [图标] 子节点A           │
│  ├─ [图标] 子节点B           │
│  └─ ...                     │
├─────────────────────────────┤
│  [进入下一层级]  [查看详情]   │
└─────────────────────────────┘
```

#### 7.2 关联节点显示

- 显示所有与当前节点有连接关系的节点
- 标注连接方向：`→ 输出到` 或 `← 输入自`
- 标注连接标签（如"数据同步"、"遥控指令"）
- 点击可切换聚焦到该节点

---

### 八、设计优势

1. **视觉聚焦**：通过虚化无关元素，让用户专注于关心的内容
2. **位置保留**：原始节点位置不变，用户不会迷失方向感
3. **动画流畅**：节点从原位置"飞出"，视觉上有明确的来源感
4. **连线重绘**：根据新位置重新计算连线，确保指向准确
5. **交互自然**：点击进入、点击退出，符合用户直觉
6. **层次清晰**：双图层架构，聚焦内容与背景分离

---

### 九、文件清单

| 文件 | 说明 |
|------|------|
| [index.html](cssc-node-view/cache/13/index.html:0:0-0:0) | 页面结构 |
| [style.css](cssc-node-view/cache/13/style.css:0:0-0:0) | 样式定义（756行 + 聚焦图层样式60行） |
| [script.js](cssc-node-view/cache/13/script.js:0:0-0:0) | 交互逻辑（约1100行） |

---

### 十、后续优化方向

1. **视觉效果**：优化虚化效果、动画曲线、配色方案
2. **性能优化**：大量节点时的渲染性能
3. **响应式**：适配不同屏幕尺寸
4. **数据对接**：与后端API对接，获取真实数据
5. **导出功能**：支持导出为图片或PDF
