# 报文配置功能代码实现说明

本文档总结了报文配置模块（新建报文及详情编辑）的前端代码结构、实现流程、核心逻辑，以及对应的后端接口、实现和服务运行指南。

## 1. 前端代码结构总览

该功能模块主要位于 `client/src/views/packet-config/` 目录下，配合 Pinia 状态管理实现。

| 文件路径 | 类型 | 作用描述 |
|---------|------|---------|
| `client/src/views/packet-config/index.vue` | View | **主入口组件**。包含面包屑、工具栏、三栏布局（左侧字段树、中间协议表、右侧属性面板容器），以及核心的路由处理和拖拽逻辑。 |
| `client/src/views/packet-config/packet-list/index.vue` | Component | **报文列表组件**。包含搜索、筛选、分页及“新增报文”入口按钮。 |
| `client/src/views/packet-config/packet-detail-editor/editor-aside.vue` | Component | **右侧属性编辑面板**。包含针对 15 种不同字段类型的专用表单逻辑。 |
| `client/src/stores/packet-config.ts` | Store | **状态管理**。定义 `Packet` 和 `PacketField` 接口，处理数据的增删改查及持久化。 |
| `client/src/stores/packet-field-options.ts` | Config | **字段类型定义**。定义了 15 种字段类型（如 SignedInt, MessageId）的元数据（名称、图标、默认属性）。 |
| `client/src/api/messageManagement.ts` | API | **后端接口**。负责与后端交互，如保存报文 (`postMessageCreate`)、获取详情 (`getMessageDetail`)。 |

## 2. 后端代码结构总览

后端功能基于 MVC 架构实现，按照 Router -> Controller -> Service -> Model 的层级组织。

| 文件路径 | 层级 | 作用描述 |
|---------|------|---------|
| `server/routes/packetMessageRouter.js` | Router | **路由层**。定义 API 接口路径，将 HTTP 请求分发给对应的控制器。 |
| `server/mvc/controllers/packetMessageController.js` | Controller | **控制器层**。接收请求参数，调用服务层处理业务，并返回统一格式的响应。 |
| `server/mvc/services/packetMessageService.js` | Service | **服务层**。核心业务逻辑，包括数据的组装、复杂查询、事务处理。 |
| `server/database/models/PacketMessage.js` | Model | **报文主体模型 (ORM)**。对应 `packet_messages` 表，存储报文基础信息（名称、设备、协议等）及字段定义（以 JSON 格式存储在 fields 字段中）。 |
| `server/mvc/models/packetMessageModel.js` | Data Access | **数据访问层 (DAO)**。封装了对报文模型的数据访问操作。 |

### 2.1 核心 API 接口
- `GET /api/packet-messages/list` - 获取报文列表
- `GET /api/packet-messages/:id` - 获取报文详情（含字段，`:id` 为报文ID占位符）
- `POST /api/packet-messages/create` - 创建新报文
- `PUT /api/packet-messages/:id` - 更新报文配置
- `DELETE /api/packet-messages/:id` - 删除报文

### 2.2 协议校验功能
- **文件**: `server/mvc/services/flowchartService.js`
- **方法**: `validateProtocolNodes()`
- **作用**: 在保存流程图时，校验协议解析/序列化节点是否配置了有效的报文，并调用 `dispatcher-analyzer` 插件检查报文配置的正确性。

## 3. 后端服务运行指南

后端服务位于项目根目录下的 `server/` 文件夹中。

### 3.1 安装依赖
首次运行前，请确保在 `server/` 目录下安装了所有依赖：
```bash
cd server
npm install
```

### 3.2 启动服务
推荐使用以下命令启动服务：

*   **开发模式** (支持热重载):
    ```bash
    npm run node:dev
    ```
*   **生产模式**:
    ```bash
    npm run node:prod
    ```

### 3.3 访问服务
服务启动成功后，可以通过以下地址访问：
- **HTTP API**: `http://localhost:9200`
- **API 文档 (Swagger)**: `http://localhost:9200/api-docs`
- **WebSocket**: `ws://localhost:9210`

### 3.4 故障排查
- **端口占用**：如果启动失败提示端口 9200 被占用，可使用 `bash 修复端口占用问题.sh` 脚本解决。
- **日志查看**：运行日志保存在 `server/logs/` 目录下（如 `app.log`, `error.log`）。

## 4. 新建报文实现流程（前端）

### 4.1 入口触发
在 `packet-list/index.vue` 中，点击“+ 新增报文”按钮触发跳转：
```typescript
function handleAddPacket() {
  router.push({ path: "/packet-config", query: { mode: "add" } });
}
```

### 4.2 路由响应与初始化
在 `index.vue` 中，`handleRouteChange` 监听路由参数变化：
- 检测到 `mode === "add"`。
- 初始化一个空白的 `Packet` 对象（包含随机 ID、默认字段等）。
- 调用 `packetStore.addPacket(np)` 将新报文加入状态管理。
- 设置 `showDetailView.value = true`，切换视图显示模式。

### 4.3 视图渲染
`index.vue` 通过 `v-show="showDetailView"` 控制显示详情编辑视图。详情视图采用三栏布局：
1.  **左侧（字段结构树）**：展示可用的字段类型，支持拖拽 (`VueDraggable`)。
2.  **中间（协议内容表格）**：展示报文的基本信息表单和字段列表，支持字段的拖拽排序和双击编辑。
3.  **右侧（属性编辑面板）**：`editor-aside.vue`，选中中间列表的字段后滑出，用于编辑具体属性。

### 4.4 字段添加逻辑
- 当从左侧拖拽字段到中间区域时，触发 `handleFieldAdd`。
- 调用 `cloneFieldType` 根据 `packet-field-options.ts` 的配置生成新的字段实例。
- 调用 `packetStore` 的方法将新字段插入到 `fields` 数组的对应位置（支持嵌套结构）。

### 4.5 保存报文
点击工具栏的“保存”按钮触发 `savePacket`：
1.  调用 `packetStore.savePacket` 更新本地状态。
2.  如果是新增模式，更新路由参数为 `mode=edit`。
3.  对数据进行格式转换（`keysToUpperCase`, `renameKeys`）以匹配后端接口要求。
4.  调用 `postMessageCreate` API 发送数据。

## 5. 详情编辑视图代码分布

详情编辑视图是一个单页编辑器，其代码逻辑分布如下：

### 主容器 (`index.vue`)
- **行数范围**：约 926 行
- **核心职责**：
    - **布局管理**：Header、Toolbar、Main Content。
    - **路由监听**：判断新增/编辑模式，加载数据。
    - **交互逻辑**：处理字段的拖拽、排序、删除、选中。
    - **组件通信**：向子组件传递 `currentPacket` 等数据。

### 属性编辑器 (`editor-aside.vue`)
- **行数范围**：约 1726 行
- **核心职责**：
    - **动态表单**：根据 `field.fieldType` 渲染不同的表单项。
    - **类型支持**：
        - **基础类型**：SignedInt, UnsignedInt, Float, String, Bcd 等。
        - **复杂类型**：Struct (结构体), Array (数组), Command (命令字)。
        - **特殊类型**：MessageId (报文标识), Timestamp (时间戳), Bitfield (位域) 等。
    - **数据绑定**：双向绑定字段属性（如 `byteLength`, `unit`, `valueRange`）。

## 6. 核心数据结构

### Packet 接口
```typescript
export interface Packet {
  id: string
  name: string
  description: string
  device: string
  protocol: string
  status: string
  fieldCount: number
  updatedAt: string
  fields: PacketField[]
  version?: string
  defaultByteOrder?: string
  structAlignment?: number | null
}
```

### PacketField 接口（简化版）
```typescript
export interface PacketField {
  id?: string              // 内部唯一ID
  fieldName: string        // 字段名称
  fieldType: string        // 字段类型（如 SignedInt）
  byteLength?: number      // 字节长度
  fields?: PacketField[]   // 嵌套字段（用于结构体）
  element?: PacketField    // 元素定义（用于数组）
  // ... 其他几十个属性根据 fieldType 不同而不同
}
```

## 7. 支持的字段类型

系统目前支持 15 种字段类型，定义在 `packet-field-options.ts` 中：

1.  **数值类**：SignedInt (有符号), UnsignedInt (无符号), Float (浮点), Bcd (BCD码)
2.  **标识类**：MessageId (报文标识)
3.  **时间类**：Timestamp (时间戳)
4.  **文本类**：String (字符串)
5.  **结构类**：Struct (结构体), Array (数组), Bitfield (位域)
6.  **逻辑类**：Encode (编码), Command (命令字)
7.  **辅助类**：Padding (填充), Reserved (保留字), Checksum (校验位)
