# 开发环境 Dockerfile
# 用途：本地开发调试，支持热重载

FROM node:22

# 安装编译工具（sqlite3 等原生模块需要）
RUN apt-get update && apt-get install -y \
    python3 \
    make \
    g++ \
    && rm -rf /var/lib/apt/lists/*

# 设置工作目录
WORKDIR /AlphaCoda

# 安装 pnpm
RUN npm install -g pnpm

# 复制 package.json（client 和 server 各自的）
COPY client/package.json client/pnpm-lock.yaml* ./client/
COPY server/package.json server/pnpm-lock.yaml* ./server/

# 安装所有依赖（包括开发依赖）
RUN cd /AlphaCoda/client && pnpm install --frozen-lockfile
RUN cd /AlphaCoda/server && pnpm install --frozen-lockfile

# 重新构建原生模块（在 Linux 环境中编译 sqlite3）
RUN cd /AlphaCoda/server && npm rebuild sqlite3 better-sqlite3

# 复制源码
COPY client/ ./client/
COPY server/ ./server/

# 暴露端口
# 9300: 前端开发服务器
# 9200: 后端 API
# 9210: WebSocket
EXPOSE 9300 9200 9210

# 复制启动脚本
COPY release-build/docker/entrypoint-dev.sh /entrypoint-dev.sh
RUN sed -i 's/\r$//' /entrypoint-dev.sh && chmod +x /entrypoint-dev.sh

# 启动开发服务（同时启动前端和后端）
CMD ["/entrypoint-dev.sh"]
